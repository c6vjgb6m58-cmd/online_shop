# 环境变量配置说明

## 问题：`Environment variable not found: DATABASE_URL`

这个错误表示缺少 `.env` 文件或 `DATABASE_URL` 环境变量未配置。

## 解决步骤

### 方法一：手动创建 .env 文件（推荐）

1. 在 `backend` 目录下创建名为 `.env` 的文件（注意：文件名就是 `.env`，没有其他名称）

2. 复制以下内容到 `.env` 文件中：

```env
# 数据库配置
# 格式：mysql://用户名:密码@主机:端口/数据库名
# 示例（使用root用户）：
DATABASE_URL="mysql://root:你的MySQL密码@localhost:3306/ecommerce"

# 如果使用专用用户，格式如下：
# DATABASE_URL="mysql://ecommerce_user:你的密码@localhost:3306/ecommerce"

# JWT密钥（用于加密token，生产环境必须更改）
JWT_SECRET="your-super-secret-jwt-key-change-in-production-123456"

# 服务器配置
PORT=3000
NODE_ENV=development

# 邮件服务配置（QQ邮箱示例，如果暂时不需要可以先用占位符）
SMTP_HOST="smtp.qq.com"
SMTP_PORT=587
SMTP_USER="your-email@qq.com"
SMTP_PASS="your-email-authorization-code"
SMTP_FROM="your-email@qq.com"

# 前端URL（用于CORS跨域）
FRONTEND_URL="http://localhost:5173"
```

3. **重要**：将 `你的MySQL密码` 替换为实际的 MySQL root 密码

### 方法二：使用命令行创建（Windows PowerShell）

在 `backend` 目录下运行：

```powershell
@"
# 数据库配置
DATABASE_URL="mysql://root:你的MySQL密码@localhost:3306/ecommerce"

# JWT密钥
JWT_SECRET="your-super-secret-jwt-key-change-in-production-123456"

# 服务器配置
PORT=3000
NODE_ENV=development

# 邮件服务配置
SMTP_HOST="smtp.qq.com"
SMTP_PORT=587
SMTP_USER="your-email@qq.com"
SMTP_PASS="your-email-authorization-code"
SMTP_FROM="your-email@qq.com"

# 前端URL
FRONTEND_URL="http://localhost:5173"
"@ | Out-File -FilePath .env -Encoding utf8
```

**注意**：记得将 `你的MySQL密码` 替换为实际密码！

### 方法三：使用命令行创建（CMD）

```cmd
cd backend
(
echo # 数据库配置
echo DATABASE_URL="mysql://root:你的MySQL密码@localhost:3306/ecommerce"
echo.
echo # JWT密钥
echo JWT_SECRET="your-super-secret-jwt-key-change-in-production-123456"
echo.
echo # 服务器配置
echo PORT=3000
echo NODE_ENV=development
echo.
echo # 邮件服务配置
echo SMTP_HOST="smtp.qq.com"
echo SMTP_PORT=587
echo SMTP_USER="your-email@qq.com"
echo SMTP_PASS="your-email-authorization-code"
echo SMTP_FROM="your-email@qq.com"
echo.
echo # 前端URL
echo FRONTEND_URL="http://localhost:5173"
) > .env
```

## 配置说明

### DATABASE_URL 格式

```
mysql://用户名:密码@主机:端口/数据库名
```

**示例：**
- 使用 root 用户：`mysql://root:mypassword@localhost:3306/ecommerce`
- 使用专用用户：`mysql://ecommerce_user:mypassword@localhost:3306/ecommerce`
- 远程数据库：`mysql://user:pass@192.168.1.100:3306/ecommerce`

### 常见配置示例

#### 本地开发（默认）
```env
DATABASE_URL="mysql://root:password@localhost:3306/ecommerce"
```

#### 使用专用用户
```env
DATABASE_URL="mysql://ecommerce_user:secure_password@localhost:3306/ecommerce"
```

#### 带时区设置
```env
DATABASE_URL="mysql://root:password@localhost:3306/ecommerce?timezone=Asia/Shanghai"
```

## 验证配置

创建 `.env` 文件后，运行以下命令验证：

```bash
cd backend
npm run db:generate
```

如果没有错误，说明配置正确。

## 常见问题

### 1. 文件创建后仍然报错

**检查：**
- 确认文件名为 `.env`（不是 `.env.txt`）
- 确认文件在 `backend` 目录下
- 确认 `DATABASE_URL` 的值用引号括起来
- 确认密码中没有特殊字符需要转义

### 2. 密码包含特殊字符

如果 MySQL 密码包含特殊字符（如 `@`、`#`、`%` 等），需要进行 URL 编码：

- `@` → `%40`
- `#` → `%23`
- `%` → `%25`
- `&` → `%26`

**示例：**
如果密码是 `pass@word#123`，应该写成：
```
DATABASE_URL="mysql://root:pass%40word%23123@localhost:3306/ecommerce"
```

### 3. 连接被拒绝

**检查：**
- MySQL 服务是否运行
- 端口是否正确（默认 3306）
- 用户名和密码是否正确
- 数据库 `ecommerce` 是否已创建

### 4. 权限错误

如果遇到权限错误，确保用户有访问数据库的权限：

```sql
GRANT ALL PRIVILEGES ON ecommerce.* TO '用户名'@'localhost';
FLUSH PRIVILEGES;
```

## 安全提示

1. **不要将 `.env` 文件提交到 Git**
   - `.env` 文件已在 `.gitignore` 中
   - 不要将包含真实密码的文件上传到代码仓库

2. **生产环境使用强密码**
   - `JWT_SECRET` 应该是一个随机生成的强密码
   - 可以使用以下命令生成：
   ```bash
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```

3. **使用环境变量管理工具**
   - 生产环境建议使用环境变量管理工具
   - 不要在代码中硬编码敏感信息

## 下一步

配置好 `.env` 文件后：

1. 重新生成 Prisma 客户端：
   ```bash
   npm run db:generate
   ```

2. 运行数据库迁移（如果还没运行）：
   ```bash
   npm run db:migrate
   ```

3. 启动服务器：
   ```bash
   npm run dev
   ```

如果还有问题，请检查：
- MySQL 服务是否运行
- 数据库是否已创建
- `.env` 文件格式是否正确


